version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: pm_db
    environment:
      POSTGRES_DB: projectmanager
      POSTGRES_USER: pm_user
      POSTGRES_PASSWORD: pm_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pm_user -d projectmanager"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pm_backend
    environment:
      NODE_ENV: development
      PORT: 3000
      
      # Database
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: pm_user
      DB_PASSWORD: pm_password
      DB_DATABASE: projectmanager
      
      # JWT
      JWT_SECRET: development-jwt-secret-change-in-production-12345678
      JWT_EXPIRES_IN: 7d
      JWT_REFRESH_SECRET: development-refresh-secret-change-in-production-12345678
      JWT_REFRESH_EXPIRES_IN: 30d
      
      # Session
      SESSION_SECRET: development-session-secret-change-in-production-12345678
      
      # 2FA
      TOTP_ISSUER: ProjectManager
      
      # Frontend URL
      FRONTEND_URL: http://localhost:5173
      
      # SMTP Email Configuration
      # For development, you can use a service like Mailtrap or Gmail
      # Example for Gmail: SMTP_HOST=smtp.gmail.com, SMTP_PORT=587, SMTP_SECURE=false
      # Example for Mailtrap: SMTP_HOST=sandbox.smtp.mailtrap.io, SMTP_PORT=2525
      # For local testing with MailHog: SMTP_HOST=mailhog, SMTP_PORT=1025
      SMTP_HOST: sandbox.smtp.mailtrap.io
      SMTP_PORT: 2525
      SMTP_SECURE: "false"
      SMTP_USER: dcf048baac6763
      SMTP_PASS: 44a4aa0411dba9
      SMTP_FROM: noreply@example.com
    ports:
      - "3001:3000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules
    command: npm run dev

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: pm_frontend
    environment:
      VITE_API_URL: http://localhost:3001/api
    ports:
      - "5173:5173"
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev

volumes:
  postgres_data:
    driver: local
