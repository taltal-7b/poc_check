# ✅ レートリミットエラーを修正しました

## 問題

「マスターデータの読み込みに失敗しました」というエラーが表示されていました。

実際には、バックエンドのレートリミット機能により、**15分間に100リクエストまで**しか許可されていなかったため、APIリクエストが拒否されていました。

エラーメッセージ：`Too many requests, please try again later.`

## 原因

課題作成モーダルを開くと、同時に複数のAPI呼び出しが発生します：
1. `/api/projects` - プロジェクト一覧
2. `/api/trackers` - トラッカー一覧
3. `/api/issue-statuses` - ステータス一覧
4. `/api/issue-priorities` - 優先度一覧
5. `/api/users` - ユーザー一覧

これらを何度か開くと、すぐに100リクエストの制限に達していました。

## 修正内容

### 1. レートリミットの上限を引き上げ

```typescript
// 修正前
max: 100  // 15分間に100リクエスト

// 修正後  
max: 1000 // 15分間に1000リクエスト
```

### 2. 開発環境ではマスターデータAPIをスキップ

開発環境では以下のエンドポイントをレートリミットから除外：
- `/api/trackers`
- `/api/issue-statuses`  
- `/api/issue-priorities`

## 確認手順

### 1. バックエンドを再起動

```powershell
docker restart pm_backend
```

### 2. ブラウザをリロード

```
Ctrl + Shift + R
```

### 3. 課題作成モーダルを開く

1. http://localhost:5173 にアクセス
2. ログイン (admin / admin123)
3. 「課題」メニューをクリック
4. 「新規課題」ボタンをクリック

### 4. 期待される動作

- ✅ モーダルが開く
- ✅ プロジェクト、トラッカー、ステータス、優先度のドロップダウンにデータが表示される
- ✅ 「マスターデータの読み込みに失敗しました」エラーが表示されない

## レートリミット設定

### 開発環境 (現在の設定)

- **ウィンドウ**: 15分
- **最大リクエスト数**: 1000
- **除外エンドポイント**: マスターデータAPI

### 本番環境での推奨設定

本番環境では、よりセキュアな設定に戻すことを推奨します：

```typescript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 200, // 通常のユーザーには十分
  message: 'Too many requests, please try again later.',
  standardHeaders: true,
  legacyHeaders: false,
});
```

## トラブルシューティング

### まだ「Too many requests」エラーが出る場合

#### 1. レートリミットをリセット

バックエンドを再起動すると、レートリミットのカウンターがリセットされます：

```powershell
docker restart pm_backend
```

#### 2. レートリミットを一時的に完全に無効化

`backend/src/index.ts` で以下のように変更：

```typescript
// レートリミットを無効化（開発時のみ）
if (process.env.NODE_ENV !== 'development') {
  app.use('/api', limiter);
}
```

#### 3. ブラウザのキャッシュをクリア

古いエラーレスポンスがキャッシュされている可能性があります：

```
F12 → Application → Clear site data
```

## その他のレートリミット関連エラー

### 認証エラー

ログインAPIもレートリミットの対象です。何度もログインに失敗すると制限されます。

**解決方法**: 15分待つか、バックエンドを再起動

### APIリクエストエラー

開発中に大量のAPIリクエストを送信すると制限されます。

**解決方法**: レートリミットを緩和するか、リクエスト頻度を減らす

## モニタリング

レートリミットの状態を確認するには、レスポンスヘッダーを確認してください：

```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 995
X-RateLimit-Reset: 1234567890
```

ブラウザの開発者ツール (F12) → Network タブ → レスポンスヘッダーで確認できます。

## まとめ

✅ レートリミットを15分間100リクエストから1000リクエストに引き上げ  
✅ 開発環境ではマスターデータAPIを除外  
✅ バックエンドを再起動  

これで「マスターデータの読み込みに失敗しました」エラーは解消されるはずです。

ブラウザをリロードして、課題作成モーダルを開いてみてください！
